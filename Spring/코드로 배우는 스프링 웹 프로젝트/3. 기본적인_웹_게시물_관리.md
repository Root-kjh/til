# 기본적인 웹 게시물 관리

## 초기설정

* java 1.8

* spring 5.0.7.RELEASE

    * spring-jdbc

    * spring-tx

* HikariCP 2.7.8

* mybatis 3.4.6

* mybatis-spring 1.3.2

* log4jdbc-log4js-jdbc4.1 1.16

* junit 4.12

* lombok 1.18.0

* maven-compiler-plugin 1.8

### DB 작업

#### 테이블 생성

* Tbl_board

|     bno     |    title   |    content   |   writer   |    regdate    |   updatedate   |
|:-----------:|:----------:|:------------:|:----------:|:-------------:|:--------------:|
|number(10,0)|varchar2(200)|varchar2(2000)|varchar2(50)|     date      |      date      |
|            |  not null   |   not null   |  not null  |default sysdate| default sysdate|

#### 시퀀스 생성

create sequence seq_board;

#### bno primary key 지정

alter table tbl_board add constraint pk_board primary key (bno);

#### 더미 데이터 삽입

insert into tbl_board(bno, title, content, writer) values(SEQ_BOARD.nextval,'테스트 제목','테스트 내용','USER00');

### DataSource & Mybatis 설정

* root-context 설정

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:mybatis-spring="http://mybatis.org/schema/mybatis-spring"
	xsi:schemaLocation="http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring-1.2.xsd
		http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd">
	
	<!-- Root Context: defines shared resources visible to all other web components -->
		
		<bean id="hikariConfig" class="com.zaxxer.hikari.HikariConfig">
			<property name="driverClassName" value="net.sf.log4jdbc.sql.jdbcapi.DriverSpy"></property>
			<property name="jdbcUrl" value="jdbc:log4jdbc:oracle:thin:@localhost:1521:orcl"></property>
			<property name="username" value="book_ex"></property>
			<property name="password" value="book_ex"></property>
		</bean>
		
		<bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource" destroy-method="close">
			<constructor-arg ref="hikariConfig"/>
		</bean>
		
		<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
			<property name="dataSource" ref="dataSource"/>
		</bean>
		
		<mybatis-spring:scan base-package="org.zerock.mapper"/>
		
</beans>
```

* JDBC Connection, DataSource Test 코드 작성

```java
package org.zerock.persistence;

import static org.junit.Assert.fail;

import java.sql.Connection;
import java.sql.DriverManager;

import org.junit.Test;

import lombok.extern.log4j.Log4j;

@Log4j
public class JDBCTests {
	static {
		try {
			Class.forName("oracle.jdbc.driver.OracleDriver");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	@Test
	public void testConnection() {
		try (Connection con=DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:orcl","book_ex","book_ex")){
			log.info(con);
		}catch (Exception e) {
			fail(e.getMessage());
		}
	}
}
```

```java
package org.zerock.persistence;

import static org.junit.Assert.fail;

import java.sql.Connection;

import javax.sql.DataSource;

import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import lombok.Setter;
import lombok.extern.log4j.Log4j;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration("file:src/main/webapp/WEB-INF/spring/root-context.xml")
@Log4j
public class DataSourceTests {

	@Setter(onMethod_ = {@Autowired})
	private DataSource dataSource;
	
	@Setter(onMethod_ = {@Autowired})
	private SqlSessionFactory SqlSessionFactory;
	
	@Test
	public void testConnection() {
		try (Connection con=dataSource.getConnection()){
			log.info(con);
		} catch (Exception e) {
			fail(e.getMessage());
		}
	}
	
	@Test
	public void testMyBatis() {
		try (SqlSession session=SqlSessionFactory.openSession();
				Connection con=session.getConnection();){
			log.info(session);
			log.info(con);
		} catch (Exception e) {
			fail(e.getMessage());
		}
	}
}
```

## CRUD 구현

### VO 클래스 작성

```java
package org.zerock.domain;

import java.util.Date;

import lombok.Data;

@Data
public class BoardVO {
		private Long bno;
		private String title;
		private String content;
		private String writer;
		private Date regdate;
		private Date updateDate;
}
```

### mapper 인터페이스 작성

```java
package org.zerock.mapper;

import java.util.List;

import org.apache.ibatis.annotations.Select;
import org.zerock.domain.BoardVO;

public interface BoardMapper {

		@Select("select * from tbl_board where bno>0")
		public List<BoardVO> getList();
}
```

### 테스트코드 작성

```java
package org.zerock.mapper;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import lombok.Setter;
import lombok.extern.log4j.Log4j;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration("file:src/main/webapp/WEB-INF/spring/root-context.xml")
@Log4j
public class BaordMapperTests {
	@Setter(onMethod_ = @Autowired)
	private BoardMapper mapper;
	
	@Test
	public void testGetList() {
		mapper.getList().forEach(board -> log.info(board));
	}
}
```

### Mapper XML 작성

* BoardMapper의 select annontation 제거 후 xml 파일 작성

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zerock.mapper.BoardMapper">

	<select id="getList" resultType="org.zerock.domain.BoardVO">
	<![CDATA[
	select * from tbl_board where bno > 0
	]]>
	</select>
</mapper>
```

### insert 구현

#### Mapper 추가

```java
		public void insert(BoardVO board);
		
		public void insertSelectKey(BoardVO board);
```

#### Mapper XML 작성

```xml
	<insert id="insert">
		insert into tbl_board(bno, title, content, writer)
		values (seq_board.nextval, #{title}, #{content}, #{writer})
	</insert>
	
	<insert id="insertSelectKey">
		<selectKey keyProperty="bno" order="BEFORE" resultType="long">
			select seq_board.nextval from dual
		</selectKey>
		
		insert into tbl_board (bno, title, content, writer)
		values (#{bno}, #{title}, #{content}, #{writer})
	</insert>
```

#### 테스트코드 작성

```java
	@Test
	public void testInsert() {
		BoardVO board=new BoardVO();
		board.setTitle("새로 작성하는 글");
		board.setContent("새로 작성하는 내용");
		board.setWriter("newbie");
		
		mapper.insert(board);
		
		log.info(board);
	}
```

### read(select) 구현

#### Mapper 추가

```java
    public BoardVO read(long bno);
```

#### Mapper XML 작성

```xml
	<select id="read" resultType="org.zerock.domain.BoardVO">
	select * from tbl_board where bno= #{bno}
	</select>
```

#### 테스트코드 작성

```java
	@Test
	public void testRead() {
		log.info(mapper.read(6));
	}
```

### delete 구현

#### Mapper 추가

```java
    public void delete(long bno);
```

#### Mapper XML 작성

```xml
	<delete id="delete">
		delete from tbl_board where bno=#{bno}
	</delete>
```

#### 테스트코드 작성

```java
	@Test
	public void testDelete() {
		mapper.delete(5);
	}
```